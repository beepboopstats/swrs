---
title: ""
format: 
  html: 
    number-sections: true
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = F)
knitr::opts_chunk$set(message = F)
## For more inspiration on customizing the html output, refer to the following:
# https://bookdown.org/yihui/rmarkdown/html-document.html#table-of-contents

```


<!-- Housekeeping -->

```{r housekeeping, include=FALSE}

# Load the libraries
library(dplyr)
googlesheets4::gs4_deauth()

for (i in list.files(here::here("R"), full.names = TRUE)) source(i)

# set path to the behavioral data within your repository 
link = "https://docs.google.com/spreadsheets/d/167rT3pKlFvfqzlXSNDd31ad4pZSzWwvz4mtAnq2I0z8/edit?gid=0#gid=0"

dttm <- pretty_datetime(Sys.time())

```

Last updated on `r dttm`

<!-- # Read data from googledrive -->

```{r get_data}
dat <- googlesheets4::read_sheet(
  link,
  sheet = 1,
  skip = 1,
  col_types = "c"
) |> 
  janitor::clean_names()
```

<!-- Check if formatting of googlesheet is okay. -->

<!-- # Tidy data -->

```{r tidy_data}
tdat <- dat |> 
  select(
    date,
    observer = observer_initial,
    col_id,
    # time = foraging_time,
    matches("^in"),
    matches("^out")
  ) |> 
  mutate(
    date = lubridate::mdy(date),
    # time = lubridate::parse_date_time(time, "H:M:S p") |> 
    #   hms::as_hms(),
    across(
      matches("^in|^out"),
      ~ as.integer(.x)
    )
  )
```

<!-- # Summarize  -->

```{r}
sdat <- tdat |> 
  group_by(date, observer, col_id) |> 
  tidyr::pivot_longer(
    cols = matches("^in|^out"),
    names_to = "inout",
    values_to = "rate"
  ) |> 
  ungroup() |> 
  mutate(
    inout = if_else(stringr::str_detect(inout, "^in"), "in", "out")
  ) |> 
  group_by(
    date, observer, col_id, inout
  ) |> 
  reframe(
    rate = sum(rate, na.rm = TRUE)
  ) |> 
  arrange(
    date, observer, col_id
  ) |> 
  tidyr::pivot_wider(
    names_from = inout,
    values_from = rate,
  )
```

# Outstanding errors

## Error: Dates

The date of observation entered is an implausible date.

> ASSUMPTION: Observation started on 14 Aug 2025.

```{r}
foo <- sdat |>
# sdat |>
  # glimpse()
  filter(
    date > Sys.Date() |
      date < lubridate::ymd("2025-08-14")
  )

if(nrow(foo) > 0) {
  foo |> 
    reactable::reactable(
      groupBy = c("observer"),
      columns = list(
        date = reactable::colDef(minWidth = 150, name = "date (ymd)")
      )
    )
} else {
  cat("None found! Good job people.")
}
```

## Error: Colony IDs

Below, we list two types of colonies:

1. __expected__ to count, but __missed__
2. __NOT expected__ to count, but __counted__

::: {.callout-note collapse=true}
## Expected, but missed

> COMING SOON.

:::

::: {.callout-warning collapse=true}
## NOT expected, but counted

> COMING SOON.

:::

# Vizualize data by colony

```{r fig.width=12, fig.height=6}
library(ggplot2)

which_colonies <- sdat$col_id |> unique()
rel_colonies <- as.integer(which_colonies) |> na.omit() |> sort()

cat(
  "Removing the following colonies from display: ", 
  setdiff(which_colonies, rel_colonies) |> paste(collapse = ", ")
)

# split into 4 groups
n_cols <- ceiling(length(rel_colonies) / 4)
col_groups <- list(
  rel_colonies[1:n_cols],
  rel_colonies[(n_cols+1):(n_cols*2)],
  rel_colonies[(2*n_cols+1):(n_cols*3)],
  rel_colonies[(3*n_cols+1):length(rel_colonies)]
)
sdat |> 
  transmute(
    col_id,
    date,
    observer,
    total_rate = `in` + out
  ) |> 
  filter(
    col_id %in% rel_colonies
  ) |> 
  mutate(
    col_group = case_when(
      col_id %in% col_groups[[1]] ~ "Random set 1",
      col_id %in% col_groups[[2]] ~ "Random set 2",
      col_id %in% col_groups[[3]] ~ "Random set 3",
      .default = "Random set 4"
    ),
    col_id = factor(col_id, levels = rev(rel_colonies))
  ) |> 
  ggplot(
    aes(
      x = as.factor(date),
      y = col_id,
      fill = total_rate
    )
  ) +
  facet_wrap(~ col_group, scales = "free_y", ncol = 4) +
  geom_tile(color = "black") +
  theme_bw(15) +
  viridis::scale_fill_viridis(direction = -1) +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5),
    axis.title.x = element_blank(),
    panel.grid.major.y = element_blank()
  )

```


# View summarized dataset

> Grouped by date and observer, total in/out rates.

```{r}
sdat |> 
  reactable::reactable(
    groupBy = c("date", "observer"),
    sortable = TRUE,
    filterable = TRUE,
    resizable = TRUE,
    height = 500,
    columns = list(
      date = reactable::colDef(minWidth = 150, name = "date (ymd)")
    )
  )
```

